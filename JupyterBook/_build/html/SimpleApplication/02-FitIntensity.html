

<!DOCTYPE html>


<html lang="en" data-content_root="" >

  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" /><meta name="generator" content="Docutils 0.18.1: http://docutils.sourceforge.net/" />

    <title>02-Fit of the intensity profiles for single stars &#8212; pyRaven</title>
  
  
  
  <script data-cfasync="false">
    document.documentElement.dataset.mode = localStorage.getItem("mode") || "";
    document.documentElement.dataset.theme = localStorage.getItem("theme") || "light";
  </script>
  
  <!-- Loaded before other Sphinx assets -->
  <link href="../_static/styles/theme.css?digest=5b4479735964841361fd" rel="stylesheet" />
<link href="../_static/styles/bootstrap.css?digest=5b4479735964841361fd" rel="stylesheet" />
<link href="../_static/styles/pydata-sphinx-theme.css?digest=5b4479735964841361fd" rel="stylesheet" />

  
  <link href="../_static/vendor/fontawesome/6.1.2/css/all.min.css?digest=5b4479735964841361fd" rel="stylesheet" />
  <link rel="preload" as="font" type="font/woff2" crossorigin href="../_static/vendor/fontawesome/6.1.2/webfonts/fa-solid-900.woff2" />
<link rel="preload" as="font" type="font/woff2" crossorigin href="../_static/vendor/fontawesome/6.1.2/webfonts/fa-brands-400.woff2" />
<link rel="preload" as="font" type="font/woff2" crossorigin href="../_static/vendor/fontawesome/6.1.2/webfonts/fa-regular-400.woff2" />

    <link rel="stylesheet" type="text/css" href="../_static/pygments.css" />
    <link rel="stylesheet" href="../_static/styles/sphinx-book-theme.css?digest=14f4ca6b54d191a8c7657f6c759bf11a5fb86285" type="text/css" />
    <link rel="stylesheet" type="text/css" href="../_static/togglebutton.css" />
    <link rel="stylesheet" type="text/css" href="../_static/copybutton.css" />
    <link rel="stylesheet" type="text/css" href="../_static/mystnb.4510f1fc1dee50b3e5859aac5469c37c29e427902b24a333a5f9fcb2f0b3ac41.css" />
    <link rel="stylesheet" type="text/css" href="../_static/sphinx-thebe.css" />
    <link rel="stylesheet" type="text/css" href="../_static/design-style.4045f2051d55cab465a707391d5b2007.min.css" />
  
  <!-- Pre-loaded scripts that we'll load fully later -->
  <link rel="preload" as="script" href="../_static/scripts/bootstrap.js?digest=5b4479735964841361fd" />
<link rel="preload" as="script" href="../_static/scripts/pydata-sphinx-theme.js?digest=5b4479735964841361fd" />
  <script src="../_static/vendor/fontawesome/6.1.2/js/all.min.js?digest=5b4479735964841361fd"></script>

    <script data-url_root="../" id="documentation_options" src="../_static/documentation_options.js"></script>
    <script src="../_static/jquery.js"></script>
    <script src="../_static/underscore.js"></script>
    <script src="../_static/_sphinx_javascript_frameworks_compat.js"></script>
    <script src="../_static/doctools.js"></script>
    <script src="../_static/clipboard.min.js"></script>
    <script src="../_static/copybutton.js"></script>
    <script src="../_static/scripts/sphinx-book-theme.js?digest=5a5c038af52cf7bc1a1ec88eea08e6366ee68824"></script>
    <script>let toggleHintShow = 'Click to show';</script>
    <script>let toggleHintHide = 'Click to hide';</script>
    <script>let toggleOpenOnPrint = 'true';</script>
    <script src="../_static/togglebutton.js"></script>
    <script>var togglebuttonSelector = '.toggle, .admonition.dropdown';</script>
    <script src="../_static/design-tabs.js"></script>
    <script>const THEBE_JS_URL = "https://unpkg.com/thebe@0.8.2/lib/index.js"
const thebe_selector = ".thebe,.cell"
const thebe_selector_input = "pre"
const thebe_selector_output = ".output, .cell_output"
</script>
    <script async="async" src="../_static/sphinx-thebe.js"></script>
    <script>window.MathJax = {"options": {"processHtmlClass": "tex2jax_process|mathjax_process|math|output_area"}}</script>
    <script defer="defer" src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js"></script>
    <script>DOCUMENTATION_OPTIONS.pagename = 'SimpleApplication/02-FitIntensity';</script>
    <link rel="index" title="Index" href="../genindex.html" />
    <link rel="search" title="Search" href="../search.html" />
    <link rel="next" title="data module" href="../API/data.html" />
    <link rel="prev" title="01 - Data Setup" href="01-DataSetup.html" />
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <meta name="docsearch:language" content="en"/>
  </head>
  
  
  <body data-bs-spy="scroll" data-bs-target=".bd-toc-nav" data-offset="180" data-bs-root-margin="0px 0px -60%" data-default-mode="">

  
  
  <a class="skip-link" href="#main-content">Skip to main content</a>
  
  <div id="pst-scroll-pixel-helper"></div>

  
  <button type="button" class="btn rounded-pill" id="pst-back-to-top">
    <i class="fa-solid fa-arrow-up"></i>
    Back to top
  </button>

  
  <input type="checkbox"
          class="sidebar-toggle"
          name="__primary"
          id="__primary"/>
  <label class="overlay overlay-primary" for="__primary"></label>
  
  <input type="checkbox"
          class="sidebar-toggle"
          name="__secondary"
          id="__secondary"/>
  <label class="overlay overlay-secondary" for="__secondary"></label>
  
  <div class="search-button__wrapper">
    <div class="search-button__overlay"></div>
    <div class="search-button__search-container">
<form class="bd-search d-flex align-items-center"
      action="../search.html"
      method="get">
  <i class="fa-solid fa-magnifying-glass"></i>
  <input type="search"
         class="form-control"
         name="q"
         id="search-input"
         placeholder="Search this book..."
         aria-label="Search this book..."
         autocomplete="off"
         autocorrect="off"
         autocapitalize="off"
         spellcheck="false"/>
  <span class="search-button__kbd-shortcut"><kbd class="kbd-shortcut__modifier">Ctrl</kbd>+<kbd>K</kbd></span>
</form></div>
  </div>
  
    <nav class="bd-header navbar navbar-expand-lg bd-navbar">
    </nav>
  
  <div class="bd-container">
    <div class="bd-container__inner bd-page-width">
      
      <div class="bd-sidebar-primary bd-sidebar">
        

  
  <div class="sidebar-header-items sidebar-primary__section">
    
    
    
    
  </div>
  
    <div class="sidebar-primary-items__start sidebar-primary__section">
        <div class="sidebar-primary-item">

  

<a class="navbar-brand logo" href="../01-intro.html">
  
  
  
  
  
    
    
      
    
    
    <img src="../_static/logo.png" class="logo__image only-light" alt="pyRaven - Home"/>
    <script>document.write(`<img src="../_static/logo.png" class="logo__image only-dark" alt="pyRaven - Home"/>`);</script>
  
  
</a></div>
        <div class="sidebar-primary-item"><nav class="bd-links" id="bd-docs-nav" aria-label="Main">
    <div class="bd-toc-item navbar-nav active">
        
        <ul class="nav bd-sidenav bd-sidenav__home-link">
            <li class="toctree-l1">
                <a class="reference internal" href="../01-intro.html">
                    pyRaven
                </a>
            </li>
        </ul>
        <p aria-level="2" class="caption" role="heading"><span class="caption-text">Simple application</span></p>
<ul class="current nav bd-sidenav">
<li class="toctree-l1"><a class="reference internal" href="../SimpleApplication.html">Introduction</a></li>
<li class="toctree-l1"><a class="reference internal" href="01-DataSetup.html">01 - Data Setup</a></li>
<li class="toctree-l1 current active"><a class="current reference internal" href="#">02-Fit of the intensity profiles for single stars</a></li>
</ul>
<p aria-level="2" class="caption" role="heading"><span class="caption-text">API</span></p>
<ul class="nav bd-sidenav">
<li class="toctree-l1"><a class="reference internal" href="../API/data.html">data module</a></li>
<li class="toctree-l1"><a class="reference internal" href="../API/params.html">params module</a></li>
<li class="toctree-l1"><a class="reference internal" href="../API/bayesobjects.html">BayesObjects module</a></li>
<li class="toctree-l1"><a class="reference internal" href="../API/fitparams.html">fitparams module</a></li>
<li class="toctree-l1"><a class="reference internal" href="../API/pattern.html">pattern module</a></li>
<li class="toctree-l1"><a class="reference internal" href="../API/profileI.html">profileI module</a></li>
<li class="toctree-l1"><a class="reference internal" href="../API/localV.html">localV module</a></li>
<li class="toctree-l1"><a class="reference internal" href="../API/diskint2.html">diskint2 module</a></li>
<li class="toctree-l1"><a class="reference internal" href="../API/loop.html">loop module</a></li>
<li class="toctree-l1"><a class="reference internal" href="../API/loop_speed2.html">loop_speed module</a></li>
<li class="toctree-l1"><a class="reference internal" href="../API/misc.html">misc module</a></li>
</ul>

    </div>
</nav></div>
    </div>
  
  
  <div class="sidebar-primary-items__end sidebar-primary__section">
  </div>
  
  <div id="rtd-footer-container"></div>


      </div>
      
      <main id="main-content" class="bd-main">
        
        

<div class="sbt-scroll-pixel-helper"></div>

          <div class="bd-content">
            <div class="bd-article-container">
              
              <div class="bd-header-article">
<div class="header-article-items header-article__inner">
  
    <div class="header-article-items__start">
      
        <div class="header-article-item"><label class="sidebar-toggle primary-toggle btn btn-sm" for="__primary" title="Toggle primary sidebar" data-bs-placement="bottom" data-bs-toggle="tooltip">
  <span class="fa-solid fa-bars"></span>
</label></div>
      
    </div>
  
  
    <div class="header-article-items__end">
      
        <div class="header-article-item">

<div class="article-header-buttons">





<div class="dropdown dropdown-download-buttons">
  <button class="btn dropdown-toggle" type="button" data-bs-toggle="dropdown" aria-expanded="false" aria-label="Download this page">
    <i class="fas fa-download"></i>
  </button>
  <ul class="dropdown-menu">
      
      
      
      <li><a href="../_sources/SimpleApplication/02-FitIntensity.ipynb" target="_blank"
   class="btn btn-sm btn-download-source-button dropdown-item"
   title="Download source file"
   data-bs-placement="left" data-bs-toggle="tooltip"
>
  

<span class="btn__icon-container">
  <i class="fas fa-file"></i>
  </span>
<span class="btn__text-container">.ipynb</span>
</a>
</li>
      
      
      
      
      <li>
<button onclick="window.print()"
  class="btn btn-sm btn-download-pdf-button dropdown-item"
  title="Print to PDF"
  data-bs-placement="left" data-bs-toggle="tooltip"
>
  

<span class="btn__icon-container">
  <i class="fas fa-file-pdf"></i>
  </span>
<span class="btn__text-container">.pdf</span>
</button>
</li>
      
  </ul>
</div>




<button onclick="toggleFullScreen()"
  class="btn btn-sm btn-fullscreen-button"
  title="Fullscreen mode"
  data-bs-placement="bottom" data-bs-toggle="tooltip"
>
  

<span class="btn__icon-container">
  <i class="fas fa-expand"></i>
  </span>

</button>



<script>
document.write(`
  <button class="btn btn-sm navbar-btn theme-switch-button" title="light/dark" aria-label="light/dark" data-bs-placement="bottom" data-bs-toggle="tooltip">
    <span class="theme-switch nav-link" data-mode="light"><i class="fa-solid fa-sun fa-lg"></i></span>
    <span class="theme-switch nav-link" data-mode="dark"><i class="fa-solid fa-moon fa-lg"></i></span>
    <span class="theme-switch nav-link" data-mode="auto"><i class="fa-solid fa-circle-half-stroke fa-lg"></i></span>
  </button>
`);
</script>


<script>
document.write(`
  <button class="btn btn-sm navbar-btn search-button search-button__button" title="Search" aria-label="Search" data-bs-placement="bottom" data-bs-toggle="tooltip">
    <i class="fa-solid fa-magnifying-glass fa-lg"></i>
  </button>
`);
</script>
<label class="sidebar-toggle secondary-toggle btn btn-sm" for="__secondary"title="Toggle secondary sidebar" data-bs-placement="bottom" data-bs-toggle="tooltip">
    <span class="fa-solid fa-list"></span>
</label>
</div></div>
      
    </div>
  
</div>
</div>
              
              

<div id="jb-print-docs-body" class="onlyprint">
    <h1>02-Fit of the intensity profiles for single stars</h1>
    <!-- Table of contents -->
    <div id="print-main-content">
        <div id="jb-print-toc">
            
            <div>
                <h2> Contents </h2>
            </div>
            <nav aria-label="Page">
                <ul class="visible nav section-nav flex-column">
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#creating-a-parameter-dictionary-for-the-intensity-profile-fitting">1. Creating a parameter dictionary for the intensity profile fitting</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#fitting-kappa-vsini-and-vmac">2. Fitting kappa, vsini, and vmac</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#saving-the-parameters">3. Saving the parameters</a></li>
</ul>
            </nav>
        </div>
    </div>
</div>

              
                
<div id="searchbox"></div>
                <article class="bd-article" role="main">
                  
  <section class="tex2jax_ignore mathjax_ignore" id="fit-of-the-intensity-profiles-for-single-stars">
<h1>02-Fit of the intensity profiles for single stars<a class="headerlink" href="#fit-of-the-intensity-profiles-for-single-stars" title="Permalink to this heading">#</a></h1>
<p>In this notebook, we demonstrate how to determine the line profile paramters that will be use to generate the synthetic Stokes V profile, base on a modelling of the Stokes I profiles.</p>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p>If you have already determined the parameters using your own tools, you can move to the next tutorial. However, as our line profiles are parametrized by <span class="math notranslate nohighlight">\(\log\kappa\)</span> (the log of the ratio of the line opacity to the continuum opacity), you will need to convert your line depth – an easy way would be to use the tools below to fit <span class="math notranslate nohighlight">\(\log\kappa\)</span> only, keeping your values for e.g. <span class="math notranslate nohighlight">\(v\sin i\)</span> fixed to your determined value.</p>
</div>
<div class="admonition warning">
<p class="admonition-title">Warning</p>
<p>The fitting demonstrated below uses an analytical formulation for the intensity line profile. While the continnum limb darkening is included in the rotational convolution kernel, the line limb-darkening is not. Therefore there will be a slight difference in shape between the analytical synthetic line profile and the line profile computer by the numerical disk integration (see details at INSERT LINK)</p>
</div>
<p>You will need to import the packages below</p>
<div class="cell tag_hide-input docutils container">
<details class="hide above-input">
<summary aria-label="Toggle hidden content">
<span class="collapsed">Show code cell source</span>
<span class="expanded">Hide code cell source</span>
</summary>
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># Importing packages</span>
<span class="kn">import</span> <span class="nn">pyRaven</span> <span class="k">as</span> <span class="nn">rav</span>

<span class="c1">#import pandas as pd</span>
<span class="c1">#import itertools</span>
<span class="c1">#from IPython.display import display</span>
<span class="kn">import</span> <span class="nn">matplotlib.pyplot</span> <span class="k">as</span> <span class="nn">plt</span>
<span class="c1">#import h5py as h5</span>
<span class="c1">#import json</span>
<span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="nn">np</span>
<span class="kn">import</span> <span class="nn">copy</span>
</pre></div>
</div>
</div>
</details>
</div>
<p>In the cell below, we load the DataPacket that we created in the previous tutorial</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">DataPacket</span> <span class="o">=</span> <span class="n">rav</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">read_packet</span><span class="p">(</span><span class="s1">&#39;ExampleOutput/01-DataSetup/ExamplePacket.h5&#39;</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<section id="creating-a-parameter-dictionary-for-the-intensity-profile-fitting">
<h2>1. Creating a parameter dictionary for the intensity profile fitting<a class="headerlink" href="#creating-a-parameter-dictionary-for-the-intensity-profile-fitting" title="Permalink to this heading">#</a></h2>
<p>A lot of the main codes in pyRaven rely on a dictionary to pass the necessary parameters necessary for computations (see LINK for details).</p>
<p>As a simple introduction here, we demonstrate two ways of creating these dictionaries (default parameter function, and direct dictionary creation), as well as how to write to file (and read back)in .json format.</p>
<p>In the cell below, we use the <code class="docutils literal notranslate"><span class="pre">params.get_def_param_fitI()</span></code> function to return a typical dictionary suitable for a calculation of the intensity profile.
We use the <code class="docutils literal notranslate"><span class="pre">pprint</span></code> method to do a pretty-print of the dictionary.
We also illustrate quickly how to edit the value of a key in a dictionary.</p>
<p>As you can see, <code class="docutils literal notranslate"><span class="pre">param</span></code> is a dictionary of sub-dictionaries (as explained ADD LINK). For the calculation of intensity profiles with the ADD FUNCTION function, we only need some elements in the <code class="docutils literal notranslate"><span class="pre">&quot;general&quot;</span></code> sub-dictionary (we would need additional sub-dictionaries if we were making Stokes V calculations, for example).</p>
<div class="cell tag_remove-output docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># Get a dictionaty with the necessary keys and default values</span>
<span class="n">param</span> <span class="o">=</span> <span class="n">rav</span><span class="o">.</span><span class="n">params</span><span class="o">.</span><span class="n">get_def_param_fitI</span><span class="p">()</span>

<span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Default values for analytical intensity line profile calculation:&#39;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="n">param</span><span class="p">)</span>

<span class="c1"># We can modify any values in the dictionary</span>
<span class="n">param</span><span class="p">[</span><span class="s2">&quot;general&quot;</span><span class="p">][</span><span class="s2">&quot;vsini&quot;</span><span class="p">]</span><span class="o">=</span><span class="mf">40.0</span>
<span class="n">param</span><span class="p">[</span><span class="s2">&quot;general&quot;</span><span class="p">][</span><span class="s2">&quot;logkappa&quot;</span><span class="p">]</span><span class="o">=-</span><span class="mf">0.4</span>

<span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Our modified dictionary&#39;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="n">param</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<!-- This is a markdown cell to show two tabs with each containing the output of one of the print() above -->
<div class="sd-tab-set docutils">
<input checked="checked" id="sd-tab-item-0" name="sd-tab-set-0" type="radio">
</input><label class="sd-tab-label" for="sd-tab-item-0">
Default values:</label><div class="sd-tab-content docutils">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>{&#39;general&#39;: {&#39;lambda0&#39;: 5000,
  &#39;vsini&#39;: 40.0,
  &#39;vmac&#39;: 5.0,
  &#39;vdop&#39;: 10.0,
  &#39;av&#39;: 0.05,
  &#39;bnu&#39;: 1.5,
  &#39;logkappa&#39;: -0.4,
  &#39;ndop&#39;: 10,
  &#39;res&#39;: 65000}}
</pre></div>
</div>
</div>
<input id="sd-tab-item-1" name="sd-tab-set-0" type="radio">
</input><label class="sd-tab-label" for="sd-tab-item-1">
Our modified params dictionary:</label><div class="sd-tab-content docutils">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>{&#39;general&#39;: {&#39;lambda0&#39;: 5000,
  &#39;vsini&#39;: 40.0,
  &#39;vmac&#39;: 5.0,
  &#39;vdop&#39;: 10.0,
  &#39;av&#39;: 0.05,
  &#39;bnu&#39;: 1.5,
  &#39;logkappa&#39;: -0.4,
  &#39;ndop&#39;: 10,
  &#39;res&#39;: 65000}}
</pre></div>
</div>
</div>
</div>
<!-- this is a markdown cell to show a dropdown box with an alternative method to create a params dictionary -->
<div class="note dropdown admonition">
<p class="admonition-title">Click to preview an alternative method to create a params dictionary. </p>
<p>See LINK for a more detailed documentation and list of options</p>
<p>We first create the dictionary that contains the necessary keywords in the <code class="docutils literal notranslate"><span class="pre">&quot;general&quot;</span></code> sub-dictionary. As we only need this sub-dictionary for the intensity profile calculations below, we then create the main dictionary with only the ‘general’ sub-dictionary. We use the <code class="docutils literal notranslate"><span class="pre">params.parameters(dict)</span></code> class to create a <code class="docutils literal notranslate"><span class="pre">parameters</span></code> object (which is simply a regular dictionary with a few add-ons) so that we can use the <code class="docutils literal notranslate"><span class="pre">pprint()</span></code> method afterwards (but this is not strickly necessary to use the pyRaven calculation codes)</p>
<div class="highlight-python3 notranslate"><div class="highlight"><pre><span></span><span class="n">genparam</span> <span class="o">=</span> <span class="p">{</span>
    <span class="s1">&#39;lambda0&#39;</span><span class="p">:</span><span class="mi">5000</span><span class="p">,</span>    <span class="c1"># the central wavelength of the transition</span>
    <span class="s1">&#39;vsini&#39;</span><span class="p">:</span><span class="mf">40.0</span><span class="p">,</span>      <span class="c1"># the projected rotational velocity</span>
    <span class="s1">&#39;vmac&#39;</span><span class="p">:</span><span class="mf">5.0</span><span class="p">,</span>        <span class="c1"># the gaussian macroturbulence velocity</span>
    <span class="s1">&#39;vdop&#39;</span><span class="p">:</span><span class="mf">10.0</span><span class="p">,</span>       <span class="c1"># the thermal broadening</span>
    <span class="s1">&#39;av&#39;</span><span class="p">:</span><span class="mf">0.05</span><span class="p">,</span>         <span class="c1"># the damping coefficient of the Voigt profile</span>
    <span class="s1">&#39;bnu&#39;</span><span class="p">:</span><span class="mf">1.5</span><span class="p">,</span>         <span class="c1"># the slope of the source function with respect to vertical optical depth</span>
    <span class="s1">&#39;logkappa&#39;</span><span class="p">:</span><span class="mf">0.98</span><span class="p">,</span>   <span class="c1"># the line strength parameter</span>
    <span class="s1">&#39;ndop&#39;</span><span class="p">:</span><span class="nb">int</span><span class="p">(</span><span class="mi">10</span><span class="p">),</span>    <span class="c1"># the number of sample point per doppler width for the wavelength array</span>
    <span class="s1">&#39;res&#39;</span><span class="p">:</span><span class="mi">65000</span>        <span class="c1"># the spectral resolution lambda0 / (FWHM delta lambda)</span>
  <span class="p">}</span>

<span class="n">param</span><span class="o">=</span><span class="n">rav</span><span class="o">.</span><span class="n">params</span><span class="o">.</span><span class="n">parameters</span><span class="p">({</span><span class="s1">&#39;general&#39;</span> <span class="p">:</span> <span class="n">genparam</span><span class="p">})</span>

<span class="n">param</span><span class="o">.</span><span class="n">pprint</span><span class="p">()</span>
</pre></div>
</div>
</div>
<p>In the cell below, we illustrate how to use the <code class="docutils literal notranslate"><span class="pre">write</span></code> method of the <code class="docutils literal notranslate"><span class="pre">parameters</span></code> dictionary class to write the information to a .json file for safe-keeping.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">param</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s1">&#39;ExampleOutput/02-FitIntensity/FitI_param_initial.json&#39;</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<p>In the cell below, we show how to read back these .json files back into a <code class="docutils literal notranslate"><span class="pre">parameters</span></code> dictionary object.</p>
<aside class="margin sidebar">
<p class="sidebar-title"></p>
<div class="admonition tip">
<p class="admonition-title">Tip</p>
<p>As the json format is easily human-readable, it is also possible to use these files as input files to create your parameters dictionaries. (However, please note the subtleties with python lists versus numpy arrays described in ADD LINK, especially for the parameters related to the unno zeeman parameters and the loop grid parameters).</p>
</div>
</aside>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">param</span> <span class="o">=</span> <span class="n">rav</span><span class="o">.</span><span class="n">params</span><span class="o">.</span><span class="n">read_parameters</span><span class="p">(</span><span class="s1">&#39;ExampleOutput/02-FitIntensity/FitI_param_initial.json&#39;</span><span class="p">)</span>

<span class="nb">print</span><span class="p">(</span><span class="n">param</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>{
  &quot;general&quot;: {
    &quot;av&quot;: 0.05,
    &quot;bnu&quot;: 1.5,
    &quot;lambda0&quot;: 5000,
    &quot;logkappa&quot;: -0.4,
    &quot;ndop&quot;: 10,
    &quot;res&quot;: 65000,
    &quot;vdop&quot;: 10.0,
    &quot;vmac&quot;: 5.0,
    &quot;vsini&quot;: 40.0
  }
}
</pre></div>
</div>
</div>
</div>
<p>Finally, we can use the params dictionary to compute a model, and display it against the LSD profiles in the DataPacket.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># compute the analytical model</span>
<span class="n">model</span> <span class="o">=</span> <span class="n">rav</span><span class="o">.</span><span class="n">diskint2</span><span class="o">.</span><span class="n">analytical</span><span class="p">(</span><span class="n">param</span><span class="p">)</span>

<span class="c1"># Plot the scaled and normalized LSD profiles in the DataPacket</span>
<span class="n">fig</span><span class="p">,</span> <span class="n">ax</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="mi">1</span><span class="p">)</span>
<span class="n">ax</span> <span class="o">=</span> <span class="n">DataPacket</span><span class="o">.</span><span class="n">scaled</span><span class="o">.</span><span class="n">plotI</span><span class="p">(</span><span class="n">ax</span><span class="p">)</span>

<span class="c1"># overplot the model on the middle panel</span>
<span class="n">ax</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">model</span><span class="p">[</span><span class="s1">&#39;vel&#39;</span><span class="p">],</span> <span class="n">model</span><span class="p">[</span><span class="s1">&#39;flux&#39;</span><span class="p">],</span> <span class="n">ls</span><span class="o">=</span><span class="s1">&#39;--&#39;</span><span class="p">,</span> <span class="n">c</span><span class="o">=</span><span class="s1">&#39;k&#39;</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>[&lt;matplotlib.lines.Line2D at 0x1662cd2e0&gt;]
</pre></div>
</div>
<img alt="../_images/c881b577eded1630e9e570dfb3a0b595e42afbbdb6ef0f016c4809ac06a1fb1d.png" src="../_images/c881b577eded1630e9e570dfb3a0b595e42afbbdb6ef0f016c4809ac06a1fb1d.png" />
</div>
</div>
<p>Of course, our initial (mostly default) parameters are not reproducing well the line profiles. We can adjust parameters by hand (by editing the dictionary object or file), which might be the best way for things like the thermal velocity, the spectral resolution, etc. You can also set the parameters to the values you might have already derived from your own tools.</p>
<p>The next section shows how to use tools in pyRaven to fit the line profiles for commonly fitted parameters.</p>
</section>
<section id="fitting-kappa-vsini-and-vmac">
<h2>2. Fitting kappa, vsini, and vmac<a class="headerlink" href="#fitting-kappa-vsini-and-vmac" title="Permalink to this heading">#</a></h2>
<p>The <code class="docutils literal notranslate"><span class="pre">fitparams.py</span></code> module contains two functions that can fit <span class="math notranslate nohighlight">\(\kappa\)</span>, <span class="math notranslate nohighlight">\(v\sin i\)</span>, and <span class="math notranslate nohighlight">\(v_\mathrm{mac}\)</span>.</p>
<p>We must first set up our param dictionary and DataPacket. Here, we just read in the param file we created earlier and reading the data packet</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">param_initial</span> <span class="o">=</span> <span class="n">rav</span><span class="o">.</span><span class="n">params</span><span class="o">.</span><span class="n">read_parameters</span><span class="p">(</span><span class="s1">&#39;ExampleOutput/02-FitIntensity/FitI_param_initial.json&#39;</span><span class="p">)</span>
<span class="n">DataPacket</span> <span class="o">=</span> <span class="n">rav</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">read_packet</span><span class="p">(</span><span class="s1">&#39;ExampleOutput/01-DataSetup/ExamplePacket.h5&#39;</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<p>The first method for fitting the three values is using scipy’s <code class="docutils literal notranslate"><span class="pre">curve_fit</span></code> function. We can pass the param dictionary, DataPacket, and an arry containing guess values of <span class="math notranslate nohighlight">\(\kappa\)</span>, <span class="math notranslate nohighlight">\(v\sin i\)</span>, and <span class="math notranslate nohighlight">\(v_\mathrm{mac}\)</span> to <code class="docutils literal notranslate"><span class="pre">rav.fitparams.fitdata</span></code>. This will output an array with the three values (saved as <code class="docutils literal notranslate"><span class="pre">parameters</span></code> below), the covariance matrix (<code class="docutils literal notranslate"><span class="pre">covariance</span></code>), and the model output from <code class="docutils literal notranslate"><span class="pre">rav.diskint2.analytical</span></code> (<code class="docutils literal notranslate"><span class="pre">modelout</span></code>).</p>
<div class="warning admonition">
<p class="admonition-title">TODO</p>
<p>Fit is done on the Packet.scaled – should be done on the Packet.cutfit ?</p>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># The guess is in the order: kappa, vsini, vmac</span>
<span class="n">guess</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="o">-</span><span class="mf">0.4</span><span class="p">,</span> <span class="n">DataPacket</span><span class="o">.</span><span class="n">vsini</span><span class="p">,</span> <span class="mf">30.0</span><span class="p">])</span>

<span class="n">param_best</span><span class="p">,</span><span class="n">covariance</span><span class="p">,</span><span class="n">modelout</span> <span class="o">=</span> <span class="n">rav</span><span class="o">.</span><span class="n">fitparams</span><span class="o">.</span><span class="n">fitdata</span><span class="p">(</span><span class="n">param_initial</span><span class="p">,</span><span class="n">DataPacket</span><span class="p">,</span><span class="n">guess</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="n">param_best</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>{
  &quot;general&quot;: {
    &quot;av&quot;: 0.05,
    &quot;bnu&quot;: 1.5,
    &quot;lambda0&quot;: 5000,
    &quot;logkappa&quot;: -0.18623580102443804,
    &quot;ndop&quot;: 10,
    &quot;res&quot;: 65000,
    &quot;vdop&quot;: 10.0,
    &quot;vmac&quot;: 40.585414058154896,
    &quot;vsini&quot;: 185.2605073467578
  }
}
</pre></div>
</div>
</div>
</div>
<p>We can make a graph of the data and the best fit</p>
<div class="cell tag_hide-input docutils container">
<details class="hide above-input">
<summary aria-label="Toggle hidden content">
<span class="collapsed">Show code cell source</span>
<span class="expanded">Hide code cell source</span>
</summary>
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># Make a figure and plot the scaled LSD Stokes I profiles</span>
<span class="n">fig</span><span class="p">,</span> <span class="n">ax</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="mi">1</span><span class="p">)</span>
<span class="n">ax</span> <span class="o">=</span> <span class="n">DataPacket</span><span class="o">.</span><span class="n">scaled</span><span class="o">.</span><span class="n">plotI</span><span class="p">(</span><span class="n">ax</span><span class="p">)</span>
<span class="n">ax</span><span class="o">.</span><span class="n">set_xlim</span><span class="p">(</span><span class="o">-</span><span class="mi">500</span><span class="p">,</span><span class="mi">500</span><span class="p">)</span>

<span class="c1"># compute the model with the best fit parameters</span>
<span class="n">model</span> <span class="o">=</span> <span class="n">rav</span><span class="o">.</span><span class="n">diskint2</span><span class="o">.</span><span class="n">analytical</span><span class="p">(</span><span class="n">param_best</span><span class="p">)</span>
<span class="n">ax</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">model</span><span class="p">[</span><span class="s1">&#39;vel&#39;</span><span class="p">],</span> <span class="n">model</span><span class="p">[</span><span class="s1">&#39;flux&#39;</span><span class="p">],</span> <span class="n">c</span><span class="o">=</span><span class="s1">&#39;k&#39;</span><span class="p">,</span> <span class="n">ls</span><span class="o">=</span><span class="s1">&#39;dotted&#39;</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s1">&#39;Analytical&#39;</span><span class="p">)</span>

<span class="n">l</span> <span class="o">=</span> <span class="n">ax</span><span class="o">.</span><span class="n">legend</span><span class="p">(</span><span class="n">loc</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
</pre></div>
</div>
</div>
</details>
<div class="cell_output docutils container">
<img alt="../_images/ed6e59edefa1ede1dec36c388349d09ae21a05ec620b07853e384899f85ba5cd.png" src="../_images/ed6e59edefa1ede1dec36c388349d09ae21a05ec620b07853e384899f85ba5cd.png" />
</div>
</div>
<p>Additionally, we can also perform a fit of kappa and vmac while keeping vsini fixed. This could be useful if, for example, you have already determined <span class="math notranslate nohighlight">\(v\sin i\)</span> through other means.</p>
<p>This is done by using the <code class="docutils literal notranslate"><span class="pre">fitdata_novsini</span></code> function as done below.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># Guess is [logkappa, vmac]</span>
<span class="n">guess</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="mf">1.3</span><span class="p">,</span><span class="mi">30</span><span class="p">])</span>

<span class="c1"># Change the vsini in the initial parameter param object to a fixed value</span>
<span class="n">param_initial</span><span class="p">[</span><span class="s1">&#39;general&#39;</span><span class="p">][</span><span class="s1">&#39;vsini&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="mf">120.0</span>

<span class="n">param_best_novsini</span><span class="p">,</span><span class="n">covariance</span><span class="p">,</span><span class="n">modelout</span> <span class="o">=</span> <span class="n">rav</span><span class="o">.</span><span class="n">fitparams</span><span class="o">.</span><span class="n">fitdata_novsini</span><span class="p">(</span><span class="n">param_initial</span><span class="p">,</span><span class="n">DataPacket</span><span class="p">,</span><span class="n">guess</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="n">param_best_novsini</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>{
  &quot;general&quot;: {
    &quot;av&quot;: 0.05,
    &quot;bnu&quot;: 1.5,
    &quot;lambda0&quot;: 5000,
    &quot;logkappa&quot;: -0.17280225579451547,
    &quot;ndop&quot;: 10,
    &quot;res&quot;: 65000,
    &quot;vdop&quot;: 10.0,
    &quot;vmac&quot;: 89.64750988867456,
    &quot;vsini&quot;: 120.0
  }
}
</pre></div>
</div>
</div>
</div>
<p>and now we can plot this fit</p>
<div class="cell tag_hide-input docutils container">
<details class="hide above-input">
<summary aria-label="Toggle hidden content">
<span class="collapsed">Show code cell source</span>
<span class="expanded">Hide code cell source</span>
</summary>
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># Make a figure and plot the scaled LSD Stokes I profiles</span>
<span class="n">fig</span><span class="p">,</span> <span class="n">ax</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="mi">1</span><span class="p">)</span>
<span class="n">ax</span> <span class="o">=</span> <span class="n">DataPacket</span><span class="o">.</span><span class="n">scaled</span><span class="o">.</span><span class="n">plotI</span><span class="p">(</span><span class="n">ax</span><span class="p">)</span>
<span class="n">ax</span><span class="o">.</span><span class="n">set_xlim</span><span class="p">(</span><span class="o">-</span><span class="mi">500</span><span class="p">,</span><span class="mi">500</span><span class="p">)</span>

<span class="c1"># compute the model with the best fit parameters</span>
<span class="n">model</span> <span class="o">=</span> <span class="n">rav</span><span class="o">.</span><span class="n">diskint2</span><span class="o">.</span><span class="n">analytical</span><span class="p">(</span><span class="n">param_best_novsini</span><span class="p">)</span>
<span class="n">ax</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">model</span><span class="p">[</span><span class="s1">&#39;vel&#39;</span><span class="p">],</span> <span class="n">model</span><span class="p">[</span><span class="s1">&#39;flux&#39;</span><span class="p">],</span> <span class="n">c</span><span class="o">=</span><span class="s1">&#39;k&#39;</span><span class="p">,</span> <span class="n">ls</span><span class="o">=</span><span class="s1">&#39;dotted&#39;</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s1">&#39;Analytical&#39;</span><span class="p">)</span>

<span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">DataPacket</span><span class="o">.</span><span class="n">scaled</span><span class="o">.</span><span class="n">lsds</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">vel</span><span class="p">,</span><span class="n">modelout</span><span class="p">,</span><span class="n">c</span><span class="o">=</span><span class="s1">&#39;k&#39;</span><span class="p">,</span><span class="n">label</span><span class="o">=</span><span class="s1">&#39;Fit Model&#39;</span><span class="p">,</span> <span class="n">ls</span><span class="o">=</span><span class="s1">&#39;--&#39;</span><span class="p">)</span>


<span class="n">l</span> <span class="o">=</span> <span class="n">ax</span><span class="o">.</span><span class="n">legend</span><span class="p">(</span><span class="n">loc</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
</pre></div>
</div>
</div>
</details>
<div class="cell_output docutils container">
<img alt="../_images/e1b9f772d5dcfb7ff5985d0a8bddafbe701da7029639f660fba21f5ef6941513.png" src="../_images/e1b9f772d5dcfb7ff5985d0a8bddafbe701da7029639f660fba21f5ef6941513.png" />
</div>
</div>
</section>
<section id="saving-the-parameters">
<h2>3. Saving the parameters<a class="headerlink" href="#saving-the-parameters" title="Permalink to this heading">#</a></h2>
<p>Here, we opt to save the final parameters in a file, to be use in the next tutorial. You can certainly use other methods (e.g. spreadsheet or other) than works the best with your own workflow.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">param_best</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s1">&#39;ExampleOutput/02-FitIntensity/FitI_param_bestfit.json&#39;</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
</section>
</section>

    <script type="text/x-thebe-config">
    {
        requestKernel: true,
        binderOptions: {
            repo: "binder-examples/jupyter-stacks-datascience",
            ref: "master",
        },
        codeMirrorConfig: {
            theme: "abcdef",
            mode: "python"
        },
        kernelOptions: {
            name: "python3",
            path: "./SimpleApplication"
        },
        predefinedOutput: true
    }
    </script>
    <script>kernelName = 'python3'</script>

                </article>
              

              
              
              
              
                <footer class="prev-next-footer">
                  
<div class="prev-next-area">
    <a class="left-prev"
       href="01-DataSetup.html"
       title="previous page">
      <i class="fa-solid fa-angle-left"></i>
      <div class="prev-next-info">
        <p class="prev-next-subtitle">previous</p>
        <p class="prev-next-title">01 - Data Setup</p>
      </div>
    </a>
    <a class="right-next"
       href="../API/data.html"
       title="next page">
      <div class="prev-next-info">
        <p class="prev-next-subtitle">next</p>
        <p class="prev-next-title">data module</p>
      </div>
      <i class="fa-solid fa-angle-right"></i>
    </a>
</div>
                </footer>
              
            </div>
            
            
              
                <div class="bd-sidebar-secondary bd-toc"><div class="sidebar-secondary-items sidebar-secondary__inner">

  <div class="sidebar-secondary-item">
  <div class="page-toc tocsection onthispage">
    <i class="fa-solid fa-list"></i> Contents
  </div>
  <nav class="bd-toc-nav page-toc">
    <ul class="visible nav section-nav flex-column">
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#creating-a-parameter-dictionary-for-the-intensity-profile-fitting">1. Creating a parameter dictionary for the intensity profile fitting</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#fitting-kappa-vsini-and-vmac">2. Fitting kappa, vsini, and vmac</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#saving-the-parameters">3. Saving the parameters</a></li>
</ul>
  </nav></div>

</div></div>
              
            
          </div>
          <footer class="bd-footer-content">
            
<div class="bd-footer-content__inner container">
  
  <div class="footer-item">
    
<p class="component-author">
By Petit et al.
</p>

  </div>
  
  <div class="footer-item">
    

  <p class="copyright">
    
      © Copyright 2022.
      <br/>
    
  </p>

  </div>
  
  <div class="footer-item">
    
  </div>
  
  <div class="footer-item">
    
  </div>
  
</div>
          </footer>
        

      </main>
    </div>
  </div>
  
  <!-- Scripts loaded after <body> so the DOM is not blocked -->
  <script src="../_static/scripts/bootstrap.js?digest=5b4479735964841361fd"></script>
<script src="../_static/scripts/pydata-sphinx-theme.js?digest=5b4479735964841361fd"></script>

  <footer class="bd-footer">
  </footer>
  </body>
</html>